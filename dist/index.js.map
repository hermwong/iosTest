{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["var RSVP = require('rsvp');\nglobal.Promise = RSVP.Promise;\nrequire('regenerator/runtime');\nvar fs = require('fs');\nvar express = require('express');\nvar compression = require('compression');\nvar readFile = RSVP.denodeify(fs.readFile);\nvar gzipStatic = require('connect-gzip-static');\nvar cookieParser = require('cookie-parser');\nvar url = require('url');\nvar zlib = require('zlib');\nglobal.dust = require('dustjs-linkedin');\n\n// dust templates\nrequire('./server-templates/base');\nrequire('./server-templates/index');\nrequire('./server-templates/flags');\nrequire('./server-templates/article-shell');\nrequire('./server-templates/article');\nrequire('./server-templates/article-stream');\n\nvar Flags = require('./isojs/flags');\nvar wikipedia = require('./wikipedia');\nvar wikiDisplayDate = require('./isojs/wiki-display-date');\nvar articleHeader = require('./shared-templates/article-header');\n\nvar app = express();\n\nvar inlineCss = readFile(__dirname + '/public/css/head.css', {encoding: 'utf8'});\n\nvar env = process.env.NODE_ENV;\nvar staticOptions = {\n  maxAge: env === 'production' ? '500 days' : 0\n};\n\napp.set('port', (process.env.PORT || 8000));\n\napp.use('/js', gzipStatic('public/js', staticOptions));\napp.use('/css', gzipStatic('public/css', staticOptions));\napp.use('/imgs', gzipStatic('public/imgs', staticOptions));\napp.use('/sw.js', gzipStatic('public/sw.js', {\n  maxAge: 0\n}));\napp.use('/manifest.json', gzipStatic('public/manifest.json'));\napp.use('/google589825ec7319e599.html', gzipStatic('public/google589825ec7319e599.html'));\n\napp.use(cookieParser(), (req, res, next) => {\n  req.flags = new Flags(\n    req.cookies.flags || '',\n    url.parse(req.url).query || ''\n  );\n\n  next();\n});\n\nfunction sendDustTemplateOutput(req, res, name, data) {\n  if (req.flags.get('disable-chunking')) {\n    dust.render(name, data, (err, str) => res.send(str));\n  }\n  else {\n    dust.stream(name, data).pipe(res);\n  }\n}\n\napp.get('/', compression({\n  flush: zlib.Z_PARTIAL_FLUSH\n}), (req, res) => {\n  res.status(200);\n  res.type('html');\n  sendDustTemplateOutput(req, res, 'index', {\n    inlineCss: inlineCss,\n    flags: req.flags.getAll()\n  });\n});\n\napp.get('/flags', compression({\n  flush: zlib.Z_PARTIAL_FLUSH\n}), (req, res) => {\n  res.status(200);\n  res.type('html');\n  sendDustTemplateOutput(req, res, 'flags', {\n    title: \"Flags\",\n    inlineCss: inlineCss,\n    flags: req.flags.getAll()\n  });\n});\n\nasync function handlePageShellRequest(req, res) {\n  res.status(200);\n  res.type('html');\n  sendDustTemplateOutput(req, res, 'article-shell', {\n    inlineCss: inlineCss,\n    flags: req.flags.getAll()\n  });\n}\n\napp.get('/shell.html', compression({\n  flush: zlib.Z_PARTIAL_FLUSH\n}), handlePageShellRequest);\n\napp.get(/\\/wiki\\/(.+)\\.json/, compression(), async (req, res) => {\n  var name = req.params[0];\n\n  if (req.flags.get('avoid-wikipedia')) {\n    var metaContent = new Promise(r => setTimeout(r, 900)).then(_ => {\n      return readFile(__dirname + '/wikipedia/google.json').then(JSON.parse);\n    });\n  }\n  else {\n    var metaContent = wikipedia.getMetaData(name);\n  }\n\n  try {\n    var metaContent = await metaContent;\n\n    if (metaContent.err == \"Not found\") {\n      res.status(404).json({\n        err: metaContent.err\n      });\n      return;\n    }\n\n    res.json(metaContent);\n  }\n  catch (err) {\n    console.log(err, err.stack);\n    res.status(500).json({\n      err: err.message\n    });\n  }\n});\n\n// TODO: this is a horrible copy & paste job from the main server-render route. Should be refactored.\napp.get(/\\/wiki\\/(.+)\\.middle\\.inc/, compression({\n  flush: zlib.Z_PARTIAL_FLUSH\n}), async (req, res) => {\n  try {\n    var name = req.params[0];\n\n    if (req.flags.get('avoid-wikipedia')) {\n      var meta = readFile(__dirname + '/wikipedia/google.json').then(JSON.parse);\n      var articleStream = new Promise(r => setTimeout(r, 900)).then(_ => {\n        return fs.createReadStream(__dirname + '/wikipedia/google.html', {\n          encoding: 'utf8'\n        });\n      });\n    }\n    else {\n      var meta = wikipedia.getMetaData(name);\n      if (req.flags.get('no-wiki-piping')) {\n        var articleStream = wikipedia.getArticle(name);\n      }\n      else {\n        var articleStream = wikipedia.getArticleStream(name);\n      }\n    }\n\n    meta = meta.then(data => {\n      data.updated = wikiDisplayDate(new Date(data.updated));\n      data.server = true;\n      data.safeTitle = JSON.stringify(data.title);\n      data.safeUrlId = JSON.stringify(data.urlId);\n      return data;\n    });\n\n    res.status(200);\n    res.type('html');\n\n    sendDustTemplateOutput(req, res, 'article-stream', {\n      title: name.replace(/_/g, ' '),\n      flags: req.flags.getAll(),\n      content: articleStream,\n      headerContent: meta.then(meta => articleHeader(meta))\n    });\n  }\n  catch (err) {\n    console.log(err, err.stack);\n    res.write(\"ERRORD\")\n    res.end();\n  }\n});\n\napp.get(/\\/wiki\\/(.+)\\.inc/, compression({\n  flush: zlib.Z_PARTIAL_FLUSH\n}), async (req, res) => {\n  var name = req.params[0];\n\n  if (req.flags.get('avoid-wikipedia')) {\n    await new Promise(r => setTimeout(r, 900));\n    var articleStream = fs.createReadStream(__dirname + '/wikipedia/google.html', {\n      encoding: 'utf8'\n    });\n  }\n  else {\n    var articleStream = wikipedia.getArticleStream(name);\n  }\n\n  try {\n    res.status(200);\n    res.type('html');\n    articleStream.pipe(res);\n  }\n  catch (err) {\n    console.log(err, err.stack);\n    res.send(500, \"Failed\");\n  }\n});\n\napp.get('/search.json', compression(), async (req, res) => {\n  var term = (req.query.s || '').trim();\n\n  if (!term) {\n    res.json([]);\n    return;\n  }\n\n  try {\n    res.json(await wikipedia.search(req.query.s));\n  }\n  catch (err) {\n    console.log(err, err.stack);\n    res.json(500, {\n      err: err.message\n    });\n  }\n});\n\napp.get(/\\/wiki\\/(.*)/, compression({\n  flush: zlib.Z_PARTIAL_FLUSH\n}), (req, res) => {\n  try {\n    if (req.flags.get('client-render')) {\n      handlePageShellRequest(req, res);\n      return;\n    }\n\n    var name = req.params[0];\n\n    if (req.flags.get('avoid-wikipedia')) {\n      var meta = readFile(__dirname + '/wikipedia/google.json').then(JSON.parse);\n      var articleStream = new Promise(r => setTimeout(r, 900)).then(_ => {\n        return fs.createReadStream(__dirname + '/wikipedia/google.html', {\n          encoding: 'utf8'\n        });\n      });\n    }\n    else {\n      var meta = wikipedia.getMetaData(name);\n      if (req.flags.get('no-wiki-piping')) {\n        var articleStream = wikipedia.getArticle(name);\n      }\n      else {\n        var articleStream = wikipedia.getArticleStream(name);\n      }\n    }\n\n    meta = meta.then(data => {\n      data.updated = wikiDisplayDate(new Date(data.updated));\n      data.server = true;\n      data.safeTitle = JSON.stringify(data.title);\n      data.safeUrlId = JSON.stringify(data.urlId);\n      return data;\n    });\n\n    res.status(200);\n    res.type('html');\n\n    sendDustTemplateOutput(req, res, 'article', {\n      title: name.replace(/_/g, ' '),\n      inlineCss: inlineCss,\n      flags: req.flags.getAll(),\n      content: articleStream,\n      headerContent: meta.then(meta => articleHeader(meta)),\n      canonical: 'https://en.wikipedia.org/wiki/' + name\n    });\n  }\n  catch (err) {\n    console.log(err, err.stack);\n    res.write(\"ERRORD\")\n    res.end();\n  }\n});\n\napp.listen(app.get('port'), function() {\n  console.log(\"Server listening at localhost:\" + app.get('port'));\n});\n"]}